<section class="manage-element">
    <div class="row top-options">
        <div class="col-md-6">
            <button type="button" class="btn btn-link" onclick="loadPage('/view/outdoor.html')">
                <span class="glyphicon glyphicon-chevron-left"/>
                Voltar
            </button>
        </div>


        <div class="col-md-6 text-right">
            <button type="button" class="btn btn-success" onclick="newElement()">
                <span class="glyphicon glyphicon-plus-sign"/>
                Novo Painel
            </button>
        </div>

    </div>

    <section id="manage-panels">

        <fieldset>
            <legend>Painéis</legend>
            <table id="panels-table" class="table table-condensed table-hover table-striped">
                <thead>
                <th>Ordem</th>
                <th>Id</th>
                <th>Tempo na tela</th>
                <th>Titulo</th>
                <th>Mensagem</th>
                <th>Imagem</th>
                <th>Ações</th>
                </thead>
                <tbody>

                </tbody>
            </table>
        </fieldset>


    </section>

</section>
<!-- Modal -->
<div class="modal fade" id="form-modal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">
                    <span class="glyphicon glyphicon-info-sign" title="Dinamicos:
    - pt:lajeado
    - pt:gramado
    - pt:poa
    - pt:guapore
    - pt:torres"></span>
                    Gerenciamento de Painel
                </h4>
            </div>
            <div class="modal-body">

                <form id="panel-form">
                    <input type="hidden" name="id"/>

                    <input type="hidden" name="image.content"/>
                    <input type="hidden" name="image.type"/>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Ordem</label>
                                <input type="number" name="order" required class="form-control"/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tempo na tela</label>
                                <input type="number" name="timeOnScreen" value="10" required class="form-control"/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Cor de fundo</label>
                                <input type="text" name="bgColor" required class="form-control colorpicker"/>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Titulo</label>
                                <input type="text" name="title" required class="form-control"/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tamanho Fonte</label>
                                <input type="number" name="titleStyle.size" required class="form-control"/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Cor Fonte</label>
                                <input type="text" name="titleStyle.color" required class="form-control colorpicker"/>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Mensagem</label>
                                <input type="text" name="message" required class="form-control"/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tamanho Fonte</label>
                                <input type="number" name="messageStyle.size" required class="form-control"/>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Cor Fonte</label>
                                <input type="text" name="messageStyle.color" required class="form-control colorpicker"/>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <input type="file" onchange="previewFile()" accept="image/*" class="imageUpload">
                        </div>
                        <div class="col-md-2">
                            <button type="button" onclick="removeImage()" class="btn btn-warning btn-sm">
                                <span class="glyphicon glyphicon-remove"/>
                                Remover Imagem
                            </button>
                        </div>
                        <div class="col-md-6">
                            <img class="image-preview" src="" style="max-width: 100px"/>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="reset" class="btn btn-danger btn-sm" data-dismiss="modal">
                    <span class="glyphicon glyphicon-remove"/>
                    Cancelar
                </button>
                <button type="button" onclick="save()" class="btn btn-success btn-sm">
                    <span class="glyphicon glyphicon-save"/>
                    Salvar
                </button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    function previewFile() {
        var $preview = $('.image-preview');
        var file = $(".imageUpload")[0].files[0];

        if (file.type.indexOf("image") == -1) {
            alert("Somente imagens são suportadas!");
            return;
        }
        var reader = new FileReader();

        reader.addEventListener("load", function () {
            $preview.attr('src', reader.result);
            $("input[name='image.content']").val(reader.result);
            $("input[name='image.type']").val(file.type);
        }, false);

        if (file) {
            reader.readAsDataURL(file);
        }
    }
</script>

<script type="text/javascript">
    var panels = [];

    var $form = $('#panel-form');
    var $formModal = $("#form-modal");
    var $imagePreview = $('.image-preview');

    function resetForm() {
        $form.find("input").val('');
        var order = 0;
        panels.forEach(function (p) {
            order = Math.max(order, p.order);
        });
        $imagePreview.attr('src', '');
        order++;
        $form.fillForm({
            order: order,
            bgColor: '#FFF',
            timeOnScreen: 30,
            titleStyle: {
                size: 18,
                color: '#333'
            },
            messageStyle: {
                size: 14,
                color: '#333'
            }
        });
    }

    function newElement() {
        resetForm();
        $formModal.modal();
    }

    function save() {
        $.post('/api/manage/panels', $form.serializeObject())
            .then(function (data) {
                refreshTable();
                $formModal.modal('hide');
            });
    }

    function list(panels) {
        var st = function (bg, fs) {
            return 'background-color: '+bg+';font-size: ' + fs.size + 'px; color: ' + fs.color + ';';
        };
        return panels.map(function (p) {
            return '<tr>' +
                '<td>' + p.order + '</td>' +
                '<td>' + p.id + '</td>' +
                '<td>' + p.timeOnScreen + '</td>' +
                '<td style="' + st(p.bgColor, p.titleStyle) + '">' + p.title + '</td>' +
                '<td style="' + st(p.bgColor, p.messageStyle) + '">' + p.message + '</td>' +
                '<td>' +
                (p.containImage ? '<img src="' + panelImageLink(p.id) + '" width="50"/>' : '-') + '</td>' +
                '<td>' +
                '<button type="button" class="btn btn-warning btn-xs" onclick="edit(' + p.id + ')" title="Editar"><span class="glyphicon glyphicon-edit"/></button> ' +
                '<button type="button" class="btn btn-danger btn-xs" onclick="remove(' + p.id + ')" title="Remover"><span class="glyphicon glyphicon-remove"/></button> ' +
                '</td>' +
                '</tr>'
        });
    }

    function edit(id) {
        resetForm();
        var panel = panels.find(function (m) {
            return m.id === id;
        });
        $form.fillForm(panel);
        $imagePreview.attr('src', panelImageLink(panel.id));
        $formModal.modal();
    }

    function remove(id) {
        $.delete('/api/manage/panels/' + id).then(function () {
            refreshTable();
        });
    }

    function refreshTable() {
        $.getJSON('/api/manage/panels').then(function (data) {
            panels = data;
            $('#panels-table tbody').html(
                list(panels)
            )
        });

    }

    function removeImage() {
        $(".imageUpload").val('');
        $("input[name='image.content']").val('');
        $("input[name='image.type']").val('');
        $imagePreview.attr('src', '');
    }

    refreshTable();

    $('.colorpicker').colorpicker();
</script>