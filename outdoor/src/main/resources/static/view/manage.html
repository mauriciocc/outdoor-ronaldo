<button type="button" onclick="loadPage('/view/outdoor.html')">Voltar</button>


<section id="manage-panels">

    <table id="panels-table">
        <thead>
        <th>Id</th>
        <th>Tempo na tela</th>
        <th>Titulo</th>
        <th>Mensagem</th>
        <th>Imagem</th>
        <th>Ações</th>
        </thead>
        <tbody>

        </tbody>
    </table>


    <form id="panel-form">
        <input type="hidden" name="id"/>

        <input type="hidden" name="image.content"/>
        <input type="hidden" name="image.type"/>


        <label>Tempo na tela</label>
        <input type="number" name="timeOnScreen" value="10">

        <label>
            Titulo
            <input type="text" name="title">
        </label>
        <label>
            Tamanho Fonte
            <input type="number" name="titleStyle.size">
        </label>
        <label>
            Cor Fonte
            <input type="text" name="titleStyle.color">
        </label>


        <label>
            Mensagem
            <input type="text" name="message">
        </label>

        <label>
            Tamanho Fonte
            <input type="number" name="messageStyle.size">
        </label>

        <label>
            Cor Fonte
            <input type="text" name="messageStyle.color">
        </label>

        <button type="reset">
            Cancelar
        </button>
        <button type="button" onclick="save(this.form)">
            Salvar
        </button>
    </form>

    <input type="file" onchange="previewFile()" accept="image/*" name="imageUpload"><br>
    <img class="image-preview" src="" height="200" alt="Image preview...">

</section>

<script type="text/javascript">
    function previewFile() {
        var preview = $('.image-preview');
        var file = $("input[name='imageUpload']")[0].files[0];
        if (file.type.indexOf("image") == -1) {
            alert("Somente imagens são suportadas!");
            return;
        }
        var reader = new FileReader();

        reader.addEventListener("load", function () {
            preview.src = reader.result;
            $("input[name='image.content']").val(reader.result);
            $("input[name='image.type']").val(file.type);
        }, false);

        if (file) {
            reader.readAsDataURL(file);
        }
    }
</script>

<script type="text/javascript">
    var panels = [];

    var $form = $('#panel-form');

    function save(form) {
        $.post('/api/manage/panels', $(form).serializeObject())
            .then(function (data) {
                refreshTable();
                $(form).find("button[type='reset']").click();
            });
    }

    function list(panels) {
        var st = function(fs) {
            return 'font-size: '+fs.size+'px; color: '+fs.color+';';
        };
        return panels.map(function (p) {
            return '<tr><td>' + p.id + '</td><td>' + p.timeOnScreen + '</td><td style="'+st(p.titleStyle)+'">' + p.title + '</td><td style="'+st(p.messageStyle)+'">' + p.message + '</td><td><img src="'+p.image.content+'" width="50"/> </td>' +
                '<td>' +
                '<button type="button" onclick="edit(' + p.id + ')">Editar</button> ' +
                '<button type="button" onclick="remove(' + p.id + ')">Remover</button> ' +
                '</td>' +
                '</tr>'
        });
    }

    function edit(id) {
        var panel = panels.find(function (m) {
            return m.id === id;
        });
        $form.fillForm(panel)
        $('.image-preview').attr('src', panel.image.content);

    }

    function remove(id) {
        $.delete('/api/manage/panels/' + id).then(function () {
            refreshTable();
            console.log('asd2');
        });
    }

    function refreshTable() {
        $.getJSON('/api/manage/panels').then(function (data) {
            panels = data;
            $('#panels-table tbody').html(
                list(panels)
            )
        });

    }

    refreshTable();

    $form.fillForm({
        title: 'Titulo de Teste',
        titleStyle: {
            size: 18,
            color: '#333'
        },
        message: 'Mensagem de Teste',
        messageStyle: {
            size: 14,
            color: '#333'
        },
    });
</script>